<div class="exams-container">
  <!-- Header -->
  <div class="exams-header">
    <div class="header-content">
      <h1 class="page-title">Provas e Trabalhos</h1>
      <p class="page-subtitle">Gerencie suas avaliações e prazos</p>
    </div>
    <button 
      class="btn btn-primary"
      (click)="showCreateForm.set(true)"
      [disabled]="isLoading() || subjects().length === 0">
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
        <line x1="12" y1="5" x2="12" y2="19" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        <line x1="5" y1="12" x2="19" y2="12" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
      </svg>
      Nova Prova/Trabalho
    </button>
  </div>

  @if (subjects().length === 0) {
    <div class="warning-card">
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
        <path d="M10.29 3.86L1.82 18C1.64547 18.3024 1.5729 18.6453 1.60217 18.9875C1.63144 19.3297 1.76126 19.6582 1.97631 19.9265C2.19135 20.1948 2.4829 20.3908 2.814 20.488C3.14509 20.5852 3.5017 20.5793 3.83 20.471L12 18L20.17 20.471C20.4983 20.5793 20.8549 20.5852 21.186 20.488C21.5171 20.3908 21.8086 20.1948 22.0237 19.9265C22.2387 19.6582 22.3686 19.3297 22.3978 18.9875C22.4271 18.6453 22.3545 18.3024 22.18 18L13.71 3.86C13.5318 3.56631 13.2807 3.32332 12.9812 3.15447C12.6817 2.98562 12.3438 2.89625 12 2.89625C11.6562 2.89625 11.3183 2.98562 11.0188 3.15447C10.7193 3.32332 10.4682 3.56631 10.29 3.86Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        <line x1="12" y1="9" x2="12" y2="13" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        <line x1="12" y1="17" x2="12.01" y2="17" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
      </svg>
      <div>
        <h3>Nenhuma matéria encontrada</h3>
        <p>Você precisa criar pelo menos uma matéria antes de adicionar provas e trabalhos.</p>
        <a routerLink="/dashboard/subjects" class="btn btn-primary">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M12 2L2 7L12 12L22 7L12 2Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            <path d="M2 17L12 22L22 17" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            <path d="M2 12L12 17L22 12" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
          Criar Matéria
        </a>
      </div>
    </div>
  } @else {
    <!-- Create Form -->
    @if (showCreateForm()) {
      <div class="create-form">
        <div class="form-header">
          <h2>Criar Nova Prova/Trabalho</h2>
          <button class="btn btn-ghost" (click)="resetForm()">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
              <line x1="18" y1="6" x2="6" y2="18" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
              <line x1="6" y1="6" x2="18" y2="18" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
          </button>
        </div>
        <form (ngSubmit)="createExam()" class="form">
          <div class="form-row">
            <div class="form-group">
              <label for="subject_id">Matéria</label>
              <select
                id="subject_id"
                [(ngModel)]="newExam.subject_id"
                name="subject_id"
                required
                class="form-select">
                <option value="">Selecione uma matéria</option>
                @for (subject of subjects(); track subject.id) {
                  <option [value]="subject.id">{{ subject.name }}</option>
                }
              </select>
            </div>
            <div class="form-group">
              <label for="type">Tipo</label>
              <select
                id="type"
                [(ngModel)]="newExam.type"
                name="type"
                class="form-select">
                @for (type of examTypes; track type.value) {
                  <option [value]="type.value">{{ type.label }}</option>
                }
              </select>
            </div>
          </div>
          <div class="form-group">
            <label for="title">Título</label>
            <input
              type="text"
              id="title"
              [(ngModel)]="newExam.title"
              name="title"
              placeholder="Ex: Prova 1, Trabalho de Matemática..."
              required
              class="form-input">
          </div>
          <div class="form-group">
            <label for="description">Descrição</label>
            <textarea
              id="description"
              [(ngModel)]="newExam.description"
              name="description"
              placeholder="Descreva o conteúdo da prova/trabalho..."
              rows="3"
              class="form-textarea"></textarea>
          </div>
          <div class="form-group">
            <label for="due_date">Data de Entrega</label>
            <input
              type="datetime-local"
              id="due_date"
              [(ngModel)]="newExam.due_date"
              name="due_date"
              class="form-input">
          </div>
          <div class="form-actions">
            <button type="button" class="btn btn-ghost" (click)="resetForm()">
              Cancelar
            </button>
            <button type="submit" class="btn btn-primary" [disabled]="isLoading() || !newExam.title.trim() || !newExam.subject_id">
              @if (isLoading()) {
                <div class="loading-spinner small"></div>
                Criando...
              } @else {
                Criar Prova/Trabalho
              }
            </button>
          </div>
        </form>
      </div>
    }

    <!-- Loading State -->
    @if (isLoading() && exams().length === 0) {
      <div class="loading-container">
        <div class="loading-spinner"></div>
        <p>Carregando provas e trabalhos...</p>
      </div>
    } @else if (exams().length === 0) {
      <!-- Empty State -->
      <div class="empty-state">
        <svg width="64" height="64" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M9 12L11 14L15 10" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          <path d="M21 12C21 16.9706 16.9706 21 12 21C7.02944 21 3 16.9706 3 12C3 7.02944 7.02944 3 12 3C16.9706 3 21 7.02944 21 12Z" stroke="currentColor" stroke-width="2"/>
        </svg>
        <h3>Nenhuma prova/trabalho encontrado</h3>
        <p>Crie sua primeira prova ou trabalho para começar a organizar suas avaliações</p>
        <button class="btn btn-primary" (click)="showCreateForm.set(true)">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <line x1="12" y1="5" x2="12" y2="19" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            <line x1="5" y1="12" x2="19" y2="12" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
          Criar Primeira Prova/Trabalho
        </button>
      </div>
    } @else {
      <!-- Exams Grid -->
      <div class="exams-grid">
        @for (exam of exams(); track exam.id) {
          <div class="exam-card" [class.overdue]="isOverdue(exam)">
            @if (editingExam()?.id === exam.id) {
              <!-- Edit Form -->
              <div class="edit-form">
                <div class="form-row">
                  <div class="form-group">
                    <label>Matéria</label>
                    <select
                      [(ngModel)]="editingExam()!.subject_id"
                      class="form-select">
                      @for (subject of subjects(); track subject.id) {
                        <option [value]="subject.id">{{ subject.name }}</option>
                      }
                    </select>
                  </div>
                  <div class="form-group">
                    <label>Tipo</label>
                    <select
                      [(ngModel)]="editingExam()!.type"
                      class="form-select">
                      @for (type of examTypes; track type.value) {
                        <option [value]="type.value">{{ type.label }}</option>
                      }
                    </select>
                  </div>
                </div>
                <div class="form-group">
                  <label>Título</label>
                  <input
                    type="text"
                    [(ngModel)]="editingExam()!.title"
                    class="form-input">
                </div>
                <div class="form-group">
                  <label>Descrição</label>
                  <textarea
                    [(ngModel)]="editingExam()!.description"
                    rows="3"
                    class="form-textarea"></textarea>
                </div>
                <div class="form-row">
                  <div class="form-group">
                    <label>Data de Entrega</label>
                    <input
                      type="datetime-local"
                      [(ngModel)]="editingExam()!.due_date"
                      class="form-input">
                  </div>
                  <div class="form-group">
                    <label>Status</label>
                    <select
                      [(ngModel)]="editingExam()!.status"
                      class="form-select">
                      @for (status of statusOptions; track status.value) {
                        <option [value]="status.value">{{ status.label }}</option>
                      }
                    </select>
                  </div>
                </div>
                <div class="form-actions">
                  <button 
                    type="button" 
                    class="btn btn-ghost"
                    (click)="cancelEdit()">
                    Cancelar
                  </button>
                  <button 
                    type="button" 
                    class="btn btn-primary"
                    (click)="updateExam(editingExam()!)"
                    [disabled]="isLoading()">
                    @if (isLoading()) {
                      <div class="loading-spinner small"></div>
                      Salvando...
                    } @else {
                      Salvar
                    }
                  </button>
                </div>
              </div>
            } @else {
              <!-- Exam Display -->
              <div class="exam-content">
                <div class="exam-header">
                  <div class="exam-title-section">
                    <h3 class="exam-title">{{ exam.title }}</h3>
                    <div class="exam-meta">
                      <span class="exam-type">{{ getTypeLabel(exam.type) }}</span>
                      <span class="exam-subject">{{ getSubjectName(exam.subject_id) }}</span>
                    </div>
                  </div>
                  <div class="exam-actions">
                    <button 
                      class="btn btn-ghost btn-sm"
                      (click)="startEdit(exam)"
                      title="Editar">
                      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M11 4H4C3.46957 4 2.96086 4.21071 2.58579 4.58579C2.21071 4.96086 2 5.46957 2 6V20C2 20.5304 2.21071 21.0391 2.58579 21.4142C2.96086 21.7893 3.46957 22 4 22H18C18.5304 22 19.0391 21.7893 19.4142 21.4142C19.7893 21.0391 20 20.5304 20 20V13" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        <path d="M18.5 2.5C18.8978 2.10218 19.4374 1.87868 20 1.87868C20.5626 1.87868 21.1022 2.10218 21.5 2.5C21.8978 2.89782 22.1213 3.43739 22.1213 4C22.1213 4.56261 21.8978 5.10218 21.5 5.5L12 15L8 16L9 12L18.5 2.5Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                      </svg>
                    </button>
                    <button 
                      class="btn btn-ghost btn-sm btn-danger"
                      (click)="deleteExam(exam.id)"
                      title="Excluir">
                      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <polyline points="3,6 5,6 21,6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        <path d="M19 6V20C19 20.5304 18.7893 21.0391 18.4142 21.4142C18.0391 21.7893 17.5304 22 17 22H7C6.46957 22 5.96086 21.7893 5.58579 21.4142C5.21071 21.0391 5 20.5304 5 20V6M8 6V4C8 3.46957 8.21071 2.96086 8.58579 2.58579C8.96086 2.21071 9.46957 2 10 2H14C14.5304 2 15.0391 2.21071 15.4142 2.58579C15.7893 2.96086 16 3.46957 16 4V6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                      </svg>
                    </button>
                  </div>
                </div>
                
                @if (exam.description) {
                  <p class="exam-description">{{ exam.description }}</p>
                }
                
                <div class="exam-details">
                  <div class="detail-item">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                      <rect x="3" y="4" width="18" height="18" rx="2" ry="2" stroke="currentColor" stroke-width="2"/>
                      <line x1="16" y1="2" x2="16" y2="6" stroke="currentColor" stroke-width="2"/>
                      <line x1="8" y1="2" x2="8" y2="6" stroke="currentColor" stroke-width="2"/>
                      <line x1="3" y1="10" x2="21" y2="10" stroke="currentColor" stroke-width="2"/>
                    </svg>
                    <span>{{ formatDateTime(exam.due_date) }}</span>
                  </div>
                  <div class="detail-item">
                    <span class="status-badge" [class]="getStatusColor(exam.status)">
                      {{ getStatusLabel(exam.status) }}
                    </span>
                  </div>
                </div>
                
                @if (isOverdue(exam)) {
                  <div class="overdue-warning">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                      <path d="M10.29 3.86L1.82 18C1.64547 18.3024 1.5729 18.6453 1.60217 18.9875C1.63144 19.3297 1.76126 19.6582 1.97631 19.9265C2.19135 20.1948 2.4829 20.3908 2.814 20.488C3.14509 20.5852 3.5017 20.5793 3.83 20.471L12 18L20.17 20.471C20.4983 20.5793 20.8549 20.5852 21.186 20.488C21.5171 20.3908 21.8086 20.1948 22.0237 19.9265C22.2387 19.6582 22.3686 19.3297 22.3978 18.9875C22.4271 18.6453 22.3545 18.3024 22.18 18L13.71 3.86C13.5318 3.56631 13.2807 3.32332 12.9812 3.15447C12.6817 2.98562 12.3438 2.89625 12 2.89625C11.6562 2.89625 11.3183 2.98562 11.0188 3.15447C10.7193 3.32332 10.4682 3.56631 10.29 3.86Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                      <line x1="12" y1="9" x2="12" y2="13" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                      <line x1="12" y1="17" x2="12.01" y2="17" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                    <span>Prazo vencido</span>
                  </div>
                }
              </div>
            }
          </div>
        }
      </div>
    }
  }
</div>
